name: Format & Structure Check

on:
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Get target branch and changed files
        id: changes
        run: |
          TARGET=${{ github.base_ref }}
          echo "Target branch: $TARGET"
          files=$(git diff --name-only origin/$TARGET...HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Ensure changes are inside kelompok/ folder
        run: |
          if ! echo "${{ steps.changes.outputs.files }}" | grep -q "kelompok/"; then
            echo "Semua perubahan harus berada di dalam folder 'kelompok/'."
          fi

      - name: Detect kelompok folder being modified
        id: detect
        run: |
          folder=$(echo "${{ steps.changes.outputs.files }}" | grep -o "kelompok/kelompok_[0-9][0-9]" | head -n 1)

          if [ -z "$folder" ]; then
            echo "Folder kelompok tidak valid. Gunakan format: kelompok_01, kelompok_02, ... kelompok_30."
          fi

          base=${folder##*/}
          number=$(echo "$base" | grep -o "[0-9][0-9]")

          echo "folder=$folder" >> $GITHUB_OUTPUT
          echo "group=$base" >> $GITHUB_OUTPUT
          echo "number=$number" >> $GITHUB_OUTPUT
          echo "Detected folder: $folder"

      - name: Ensure only one kelompok folder is modified
        run: |
          count=$(echo "${{ steps.changes.outputs.files }}" | grep -o "kelompok/kelompok_[0-9][0-9]" | sort -u | wc -l)
          if [ "$count" -ne 1 ]; then
            echo "PR hanya boleh mengubah satu folder kelompok."
          fi

      - name: Validate README.md inside kelompok folder
        run: |
          folder="${{ steps.detect.outputs.folder }}"
          readme="$folder/README.md"

          if [ ! -f "$readme" ]; then
            echo "README.md wajib ada di dalam folder kelompok: $readme"
          fi

          if [ ! -s "$readme" ]; then
            echo "README.md ditemukan tetapi kosong. Harus berisi data anggota & summary."
          fi

      - name: Add auto-label for kelompok
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: kelompok-${{ steps.detect.outputs.number }}

      - name: Success message
        run: echo "Struktur valid. PR siap direview!"

  fail_comment:
    runs-on: ubuntu-latest
    needs: validate
    if: failure()
    steps:
      - name: Comment on failed PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ‚ùå **CI Gagal**

            Ada kesalahan pada struktur pengumpulan Tugas Besar.

            Periksa kembali:
            - Folder kelompok harus `kelompok_XX`
            - Hanya boleh mengubah satu folder kelompok
            - Harus ada README.md berisi:
              - Daftar anggota kelompok
              - Summary project

            Perbaiki lalu push ulang.
